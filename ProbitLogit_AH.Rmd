---
title: "Mortgage Market EDA"
output:
  html_document:
    df_print: paged
---

```{r include = FALSE}
# Clear environment of variables and functions
rm(list = ls(all = TRUE)) 

# Clear environmet of packages
if(is.null(sessionInfo()$otherPkgs) == FALSE)lapply(paste("package:", names(sessionInfo()$otherPkgs), sep=""), detach, character.only = TRUE, unload = TRUE)
```

```{r include = FALSE}
library(readr)
library(tidyverse)
library(janitor)
library(kableExtra)
library(gridExtra)
library(ggridges)
library(stargazer)
```

```{r include = FALSE}
#Load Data 
mld <- read_csv("MLD Data File-1.csv")
```

```{r include = FALSE}
#Data Manipulation 
names(mld) = c("married", "guideline", "obligation", "black", "hispanic", "male", "approve", "loan") 

mld$male <- as.numeric(mld$male)
mld$married <- as.numeric(mld$married)

summary(mld)
```

#Sample Selection Criteria 

* There are 3 NAs in Married. Given our data set of almost 2,000 observation, we decided to remove these observations.
* There are values of 666 in "Guideline", which is an impossible value. We decided to remove such observations as well. 
* There are loans that is more than 100% of the purchases price. We decided to remove these observations. 

```{r include = FALSE}
#Data Manipulation 
#Remove NAs and impossible values 
mld<-mld %>% 
  filter(guideline != 666) %>% 
  filter(!is.na(married)) %>% 
  filter(loan<=1)%>% 
  mutate(loan = loan *100)

#Rename Race 
mld$race <- ifelse((mld$black == 0) & (mld$hispanic == 0), "Non-Hispanic White", 
                   ifelse((mld$black == 1) & (mld$hispanic == 0), "Non-Hispanic Black", "Hispanic"))

#Rename marital status
mld$marital <-ifelse(mld$married== 1, "Married", "Unmarried")

mld <- mld %>% select(-black, -hispanic, -male, -married)

#Change variables levels' name:
mld$approve <- ifelse(mld$approve == 1, "Yes", "No")
mld$guideline <- ifelse(mld$guideline == 1, "Yes", "No")
```

#Descriptive statistics

##All observations analysis 

* There are twice more married applicants than unmarried applicants. 
* Most of the time, the application is approved (88% approval rate).
* Most application satisfied guidelines (91% of the time). 
* Most applicants are non-Hispanic White (85% White). 


```{r echo = FALSE}
count_table <- function(x){
  x<-enquo(x)
  kable(
  mld %>% 
    tabyl(!!x) %>% 
    adorn_totals(where = "row") %>%
      adorn_pct_formatting(digits = 0 ),
      digits = 2,
      format = "html",
      align = c("l","c","c")
    )%>%
  kable_styling(full_width = F)
}
count_table(marital)
count_table(race)
count_table(approve)
count_table(guideline)

```


```{r echo = FALSE}
#Categorical Variables 
bar_graph <- function(x, xtitle) { 
  ggplot(mld, aes(x)) + geom_bar() +
    theme_bw() + xlab(xtitle)+
    theme(panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())
}
grid.arrange(
bar_graph(mld$marital, "Marital Status"),
bar_graph(mld$approve, "Approval Rate"),
bar_graph(mld$guideline, "Guideline"),
bar_graph(mld$race, "Race") + coord_flip())
```

* Most loans is at 70-80% of the item purchase price. 
* Most other obligations is at 30-40% of the loan-applicant's total income. 


```{r echo = FALSE}
#Continuous Variables
par(mfrow = c(1,2))
hist(mld$loan)
hist(mld$obligation)
```

##Descriptive statistics by race/ethnicity

* Distribution of loan/purchase price is hightly skewed left. Most people apply for high proportion of loan over price. 
    + Hispanic and Non-Hispanic Black have higher average loan amount application. 
* Across races/ethnicities, people have similar percentage of other obligations over income (about 32-35% of income). 

```{r echo = FALSE}

kable(mld %>% group_by(race) %>% 
  summarize("Loan (mean)" = mean(loan), 
            "Loan (median)" = median(loan),
            "Loan (sd)" = sd(loan),
            "Other Oblig.(mean)" = mean(obligation), 
            "Other Oblig.(median)" = median(obligation),
            "Other Oblig. (sd)" = sd(obligation)), 
  caption = "Descriptive Table for Continuous variables", 
  digit = 1)%>%
  kable_styling(full_width = F)

grid.arrange(
  ggplot(mld, aes(loan)) + geom_density(aes(color = race)),
  ggplot(mld, aes(obligation)) + geom_density(aes(color = race)))



grid.arrange(
ggplot(mld, aes(marital, fill = race)) + geom_bar(position = "dodge"),
ggplot(mld, aes(approve, fill = race)) + geom_bar(position = "dodge"),
ggplot(mld, aes(guideline, fill = race)) + geom_bar(position="dodge"))
  
```

* Most White applicants have their application accepted (91%). Black people has the lowest acceptance rate (67%).
* White applicants also have the highest percentage of applications that satisfy the guidelines, while black applicant have the lowest percentage of applications that satisfy the guidelines. 


```{r echo = FALSE, message = FALSE }
kable(
  mld %>% 
    tabyl(race, approve) %>% 
    adorn_totals(where = "col") %>%
    adorn_percentages(denominator="row")%>%
      adorn_pct_formatting(digits = 0 ),
      digits = 2,
      format = "html",
      align = c("l","c","c"), 
  caption = "Approval Rate by Race/Ethnicity"
    )%>%
  kable_styling(full_width = F)

prop_graph<-function(x, y){
  x<-enquo(x)
  y<-enquo(y)
  mld %>% group_by(!!x)%>%
  count(!!y, !!x) %>% 
  mutate(prop = prop.table(n)) %>%
  ggplot(aes(x = !!x, y = prop, fill = !!y))+stat_summary(geom="bar", position = "dodge") + ylab("Probability")+
    theme_bw() + theme(panel.border = element_blank(), 
                       panel.grid.major = element_blank(),
                       panel.grid.minor = element_blank(),
                       axis.ticks.x=element_blank(), 
                       axis.text.x = element_text(angle=90, hjust=1)) + coord_flip()
    
  
}
grid.arrange(
  prop_graph(race, marital),
prop_graph(race, approve),
prop_graph(race, guideline),ncol=2)

```



```{r}
mld$approve <- ifelse(mld$approve == "Yes", 1, 0)

mld_hispanic <- filter(mld, race == "Hispanic")
mld_white <- filter(mld, race == "Non-Hispanic White")
mld_black <- filter(mld, race == "Non-Hispanic Black")
```


# Probit Model

## Overall

```{r}
probit_all <- glm(approve ~ guideline + obligation + loan + marital, family = binomial(link = "probit"), data = mld)

summary(probit_all)
```

* 

## Hispanic

```{r}
probit_hispanic <- glm(approve ~ guideline + obligation + loan + marital, family = binomial(link = "probit"), data = mld_hispanic)

summary(probit_hispanic)
```

Coefficients make intuitive directional sense; marriage could be positive or negative intuitively.


## Non-Hispanic Black

```{r}
probit_black <- glm(approve ~ guideline + obligation + loan + marital, family = binomial(link = "probit"), data = mld_black)

summary(probit_black)
```

Coefficients make intuitive directional sense; marriage could be positive or negative intuitively.

## Non-Hispanic White

```{r}
probit_white <- glm(approve ~ guideline + obligation + loan + marital, family = binomial(link = "probit"), data = mld_white)

summary(probit_white)
```

Coefficients make intuitive directional sense; marriage could be positive or negative intuitively.

# Logit Model & Odds Ratios

## Overall
```{r}
logit_all <- glm(approve ~ guideline + obligation + loan + marital, data = mld, family = "binomial")

logit_coeffs_all <- summary(logit_all)$coefficients[,1]
logit_coeffs_all


logit_odds_all <- exp(logit_coeffs_all) / (1 + exp(logit_coeffs_all))
logit_odds_all
```


## Hispanic

```{r}
logit_hispanic <- glm(approve ~ guideline + obligation + loan + marital, data = mld_hispanic, family = "binomial")

logit_coeffs_hispanic <- summary(logit_hispanic)$coefficients[,1]
logit_coeffs_hispanic


logit_odds_hispanic <- exp(logit_coeffs_hispanic) / (1 + exp(logit_coeffs_hispanic))
logit_odds_hispanic
```

## Non-Hispanic Black

```{r}
logit_black <- glm(approve ~ guideline + obligation + loan + marital, data = mld_black, family = "binomial")

logit_coeffs_black <- summary(logit_black)$coefficients[,1]
logit_coeffs_black


logit_odds_black <- exp(logit_coeffs_black) / (1 + exp(logit_coeffs_black))
logit_odds_black
```

## Non-Hispanic White
```{r}
logit_white <- glm(approve ~ guideline + obligation + loan + marital, data = mld_white, family = "binomial")

logit_coeffs_white <- summary(logit_white)$coefficients[,1]
logit_coeffs_white


logit_odds_white <- exp(logit_coeffs_white) / (1 + exp(logit_coeffs_white))
logit_odds_white
```